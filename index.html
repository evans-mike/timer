<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Time Timer (Theme Button + Dark Mode Switch)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon -->
  <link rel="icon" href="timer.png" type="image/png" />
  <!-- Apple touch icon -->
  <link rel="apple-touch-icon" href="timer.png" />

  <!-- NoSleep.js for iOS Safari wake lock -->
  <script src="https://unpkg.com/nosleep.js"></script>

  <style>
    /* RESET & BOX-SIZING */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* BODY & HTML */
    html, body {
      width: 100%;
      height: 100%;
    }
    body {
      /* iOS-like system font stack */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
                   Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background-color: #F9F9F9;
      color: #222;
      overflow-x: hidden; /* hide horizontal scroll if any */
    }

    /* A "dark-mode" class toggles a darker theme */
    body.dark-mode {
      background-color: #111;
      color: #eee;
    }

    /* GRID CONTAINER: 4 rows => top bar, controls, circle area, footer */
    .container {
      display: grid;
      grid-template-rows: auto auto 1fr auto; /* footer is last row */
      gap: 1rem;
      min-height: 100vh;
      max-width: 500px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* TOP BAR: refresh button, title, theme button, dark-mode container */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* A small container for the left side (Refresh + Theme) if you like */
    .left-buttons {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .icon-button {
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      color: #007AFF;
      padding: 0.25rem 0.5rem;
      transition: color 0.2s;
    }
    .icon-button:hover {
      color: #006AE6;
    }

    /* A standard button for theme toggling */
    .theme-button {
      font-size: 0.9rem;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: #fff;
      background-color: #007AFF;
      transition: background 0.2s ease-in-out;
    }
    .theme-button:hover {
      background-color: #006AE6;
    }

    .title {
      font-size: 1.4rem;
      font-weight: 600;
      text-align: center;
      flex: 1;
    }

    /* Dark Mode Container: label + bigger toggle switch */
    .dark-mode-container {
      display: flex;
      align-items: center;
      gap: 0.5rem; /* spacing between label and switch */
    }
    .dark-mode-label {
      font-size: 0.9rem;
    }

    /* TOGGLE SWITCH (iOS style, bigger) */
    .toggle-switch {
      position: relative;
      width: 60px;  /* bigger width */
      height: 34px; /* bigger height */
    }
    .toggle-switch input {
      display: none; /* hide the actual checkbox */
    }
    .toggle-switch label {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #ccc;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .toggle-switch label::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 3px;
      width: 28px;
      height: 28px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .toggle-switch input:checked + label {
      background: #007AFF; /* iOS blue */
    }
    .toggle-switch input:checked + label::after {
      transform: translateX(26px);
    }

    /* CONTROLS (time input) */
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .time-input {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .time-input select {
      width: 60px;
      font-size: 0.9rem;
      padding: 0.3rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      background-color: #fff;
      appearance: none;
      text-align: center;
    }

    /* CIRCLE AREA (3rd row) */
    .circle-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }
    .circle-area svg {
      display: block;
      width: 95vw;       /* ~95% on mobile */
      max-width: 450px;  /* cap at 450px on desktop */
      height: auto;
      margin: 0 auto;
    }
    .circle-icon {
      position: absolute;
      font-size: 3rem;
      pointer-events: none;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #000;
    }
    .timer-text {
      margin-top: 1rem;
      font-size: 2rem;
      color: inherit;
      text-align: center;
    }

    /* FOOTER (4th row): BuyMeACoffee link */
    .footer {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.5rem;
    }
    .footer a img {
      height: 50px; /* adjust if desired */
    }

    /* DARK MODE TWEAKS */
    body.dark-mode .icon-button {
      color: #aaa;
    }
    body.dark-mode .theme-button {
      background-color: #444;
    }
    body.dark-mode .time-input select {
      background-color: #333;
      color: #eee;
      border-color: #555;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- TOP BAR (row 1) -->
  <div class="top-bar">
    <div class="left-buttons">
      <!-- Refresh button -->
      <button id="refreshButton" class="icon-button" aria-label="Refresh">
        &#x21BB;
      </button>
      <!-- Theme toggle button -->
      <button id="themeToggleBtn" class="theme-button">
        Theme
      </button>
    </div>

    <!-- Title -->
    <div class="title">Time Timer</div>

    <!-- Dark mode container with label + bigger toggle switch -->
    <div class="dark-mode-container">
      <span class="dark-mode-label">Dark Mode</span>
      <div class="toggle-switch">
        <input type="checkbox" id="darkModeToggle" />
        <label for="darkModeToggle"></label>
      </div>
    </div>
  </div>

  <!-- CONTROLS (row 2) -->
  <div class="controls">
    <div class="time-input">
      <select id="minutesSelect"></select>
      <span>:</span>
      <select id="secondsSelect"></select>
    </div>
  </div>

  <!-- CIRCLE AREA (row 3) -->
  <div class="circle-area" id="circleArea">
    <svg id="circleSvg" viewBox="0 0 200 200">
      <g transform="scale(-1,1) translate(-200,0)">
        <!-- Background circle -->
        <circle
          id="circleBackground"
          cx="100"
          cy="100"
          r="90"
          fill="#EAEAEA"
        />
        <!-- Foreground arc wedge -->
        <path
          id="circleForeground"
          d=""
        />
      </g>
    </svg>
    <div class="circle-icon" id="circleIcon"></div>
    <div class="timer-text" id="timerText">--:--</div>
  </div>

  <!-- FOOTER (row 4): BuyMeACoffee link -->
  <div class="footer">
    <a href="https://www.buymeacoffee.com/placeholder" target="_blank">
      <img 
        src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" 
        alt="Buy Me A Coffee" 
      />
    </a>
  </div>
</div>

<script>
  // ========== Wake Lock (Chrome) + NoSleep.js (iOS) ==========
  let wakeLock = null;
  let noSleep = new NoSleep();
  let wakeLockSupported = ('wakeLock' in navigator);

  async function enableScreenAwake() {
    if (wakeLockSupported) {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log('Wake Lock active (Screen Wake Lock API)');
        wakeLock.addEventListener('release', () => {
          console.log('Wake Lock was released');
        });
      } catch (err) {
        console.warn('Wake Lock request failed, fallback to NoSleep');
        noSleep.enable();
      }
    } else {
      noSleep.enable();
      console.log('No Wake Lock support, using NoSleep.js');
    }
  }

  async function disableScreenAwake() {
    // Release Wake Lock if we have it
    if (wakeLock) {
      try {
        await wakeLock.release();
        wakeLock = null;
        console.log('Wake Lock released');
      } catch (err) {
        console.warn('Error releasing Wake Lock:', err);
      }
    }
    // Also disable NoSleep
    noSleep.disable();
    console.log('NoSleep disabled');
  }

  // ========== Timer Logic ==========

  // We'll store time + dark mode in localStorage
  const STORAGE_TIME_KEY  = 'timerValue'; // "MM:SS"
  const STORAGE_THEME_KEY = 'darkMode';   // "true" or "false"

  // Two color themes for the wedge
  const lightModernColors = {
    idle:     "#007ACC",
    running:  "#267F99",
    paused:   "#9C4CAD",
    finished: "#B24747"
  };
  const darkModernColors = {
    idle:     "#569CD6",
    running:  "#4EC9B0",
    paused:   "#C586C0",
    finished: "#D16969"
  };

  // We'll toggle between these two with the theme button
  let stateColors = lightModernColors;

  // Timer states
  let timerState = "idle";
  let totalTime = 0;
  let timeRemaining = 0;
  let countdownInterval = null;

  // No icons
  const stateIcons = {
    idle:     "",
    running:  "",
    paused:   "",
    finished: ""
  };

  // Grab elements
  const refreshButton    = document.getElementById('refreshButton');
  const themeToggleBtn   = document.getElementById('themeToggleBtn');
  const darkModeToggle   = document.getElementById('darkModeToggle');
  const minutesSelect    = document.getElementById('minutesSelect');
  const secondsSelect    = document.getElementById('secondsSelect');
  const circleArea       = document.getElementById('circleArea');
  const circleForeground = document.getElementById('circleForeground');
  const circleIcon       = document.getElementById('circleIcon');
  const timerText        = document.getElementById('timerText');

  // Populate 0..59 for minutes & seconds
  for (let i = 0; i < 60; i++) {
    const optMin = document.createElement('option');
    optMin.value = i;
    optMin.text  = i.toString();
    minutesSelect.appendChild(optMin);

    const optSec = document.createElement('option');
    optSec.value = i;
    optSec.text  = i.toString();
    secondsSelect.appendChild(optSec);
  }

  function init() {
    // Restore dark mode preference
    const storedDarkMode = localStorage.getItem(STORAGE_THEME_KEY);
    if (storedDarkMode === 'true') {
      document.body.classList.add('dark-mode');
      darkModeToggle.checked = true;
    }

    // Default time or last used
    const storedTime = localStorage.getItem(STORAGE_TIME_KEY);
    if (storedTime) {
      const [mm, ss] = storedTime.split(':').map(Number);
      minutesSelect.value = mm;
      secondsSelect.value = ss;
    } else {
      // Default 20:00
      minutesSelect.value = 20;
      secondsSelect.value = 0;
    }

    setTimerState("idle");
    updateTimerFromDropdown();
    updateTimerTextAndArc(timeRemaining);
  }

  function setTimerState(newState) {
    timerState = newState;
    circleForeground.setAttribute("fill", stateColors[newState]);
    circleIcon.innerHTML = stateIcons[newState];
  }

  function updateTimerFromDropdown() {
    const mm = parseInt(minutesSelect.value, 10);
    const ss = parseInt(secondsSelect.value, 10);
    totalTime = mm * 60 + ss;
    localStorage.setItem(STORAGE_TIME_KEY, `${mm}:${ss}`);

    if (timerState === "idle" || timerState === "finished") {
      timeRemaining = totalTime;
    }
  }

  function onCircleTap() {
    if (timerState === "idle" || timerState === "finished") {
      startTimer();
      setTimerState("running");
      enableScreenAwake();
    } else if (timerState === "running") {
      pauseTimer();
      setTimerState("paused");
      disableScreenAwake();
    } else if (timerState === "paused") {
      resumeTimer();
      setTimerState("running");
      enableScreenAwake();
    }
  }

  function startTimer() {
    clearInterval(countdownInterval);
    updateTimerFromDropdown();
    timeRemaining = totalTime;
    runInterval();
  }

  function pauseTimer() {
    clearInterval(countdownInterval);
  }

  function resumeTimer() {
    runInterval();
  }

  function runInterval() {
    updateTimerTextAndArc(timeRemaining);
    countdownInterval = setInterval(() => {
      timeRemaining -= 0.1;
      if (timeRemaining <= 0) {
        timeRemaining = 0;
        clearInterval(countdownInterval);
        setTimerState("finished");
        updateTimerTextAndArc(timeRemaining);
        disableScreenAwake();
        return;
      }
      updateTimerTextAndArc(timeRemaining);
    }, 100);
  }

  function updateTimerTextAndArc(remaining) {
    let fractionLeft = (totalTime > 0) ? remaining / totalTime : 0;
    if (fractionLeft < 0) fractionLeft = 0;
    if (fractionLeft > 1) fractionLeft = 1;

    const angle = fractionLeft * 360;
    circleForeground.setAttribute('d', describeArc(100, 100, 90, angle));
    timerText.textContent = formatTime(remaining);
  }

  function formatTime(seconds) {
    if (seconds < 0) seconds = 0;
    const mm = Math.floor(seconds / 60);
    const ss = Math.floor(seconds % 60);
    return mm + ":" + ss.toString().padStart(2, "0");
  }

  function describeArc(cx, cy, r, angleDeg) {
    if (angleDeg <= 0) {
      return '';
    }
    if (angleDeg >= 360) {
      return `
        M ${cx} ${cy - r}
        A ${r} ${r} 0 1 1 ${cx - 0.01} ${cy - r}
        Z
      `;
    }
    const largeArcFlag = (angleDeg > 180) ? 1 : 0;
    const sweepFlag    = 1;
    const angleRad     = (Math.PI / 180) * angleDeg;

    const startX = cx;
    const startY = cy - r;
    const endX   = cx + r * Math.sin(angleRad);
    const endY   = cy - r * Math.cos(angleRad);

    return `
      M ${cx} ${cy}
      L ${startX} ${startY}
      A ${r} ${r} 0 ${largeArcFlag} ${sweepFlag} ${endX} ${endY}
      Z
    `;
  }

  // Refresh => reload
  refreshButton.addEventListener('click', () => {
    location.reload();
  });

  // Dark mode toggle => toggles class, saves preference
  darkModeToggle.addEventListener('change', (e) => {
    const isDark = e.target.checked;
    document.body.classList.toggle('dark-mode', isDark);
    localStorage.setItem(STORAGE_THEME_KEY, isDark);
  });

  // Tap the circle => Start/Pause/Resume
  circleArea.addEventListener('click', onCircleTap);

  // If user changes the dropdown while idle/finished
  minutesSelect.addEventListener('change', updateTimerFromDropdown);
  secondsSelect.addEventListener('change', updateTimerFromDropdown);

  // THEME TOGGLE: Switch between lightModernColors & darkModernColors
  themeToggleBtn.addEventListener('click', () => {
    if (stateColors === lightModernColors) {
      stateColors = darkModernColors;
    } else {
      stateColors = lightModernColors;
    }
    // Refresh the wedge color for current state
    setTimerState(timerState);
  });

  // On load
  init();
</script>
</body>
</html>
